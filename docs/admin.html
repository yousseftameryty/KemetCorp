<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEMET // ADMIN_CONSOLE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="kemetadmin.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --kemet-green: #22c55e; --kemet-red: #ef4444; }
        body { background-color: #020202; color: #e5e5e5; font-family: 'Inter', sans-serif; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* === LAYOUT === */
        .admin-grid { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
        
        /* SIDEBAR */
        .sidebar { background: #000; border-right: 1px solid #222; display: flex; flex-direction: column; }
        .nav-btn {
            display: flex; align-items: center; gap: 12px; padding: 14px 24px;
            font-family: 'JetBrains Mono'; font-size: 11px; text-transform: uppercase; color: #666;
            transition: 0.2s; border-left: 2px solid transparent; cursor: pointer;
        }
        .nav-btn:hover, .nav-btn.active { background: #0a0a0a; color: white; }
        .nav-btn.active { border-left-color: var(--kemet-green); }

        /* MAIN AREA */
        .workspace { overflow-y: auto; padding: 40px; position: relative; }
        .workspace-section { display: none; animation: fadeIn 0.3s ease; }
        .workspace-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* DATA CARDS */
        .stat-card {
            background: #0a0a0a; border: 1px solid #222; padding: 20px;
            display: flex; flex-direction: column; justify-content: space-between; height: 120px;
        }
        .stat-val { font-size: 28px; font-weight: 900; letter-spacing: -0.05em; color: white; }
        .stat-lbl { font-family: 'JetBrains Mono'; font-size: 10px; color: #555; text-transform: uppercase; }

        /* INPUTS & FORMS */
        .panel-header { font-size: 24px; font-weight: 900; letter-spacing: -0.05em; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        
        .raw-input {
            width: 100%; background: #000; border: 1px solid #333; color: white;
            font-family: 'JetBrains Mono'; font-size: 12px; padding: 12px; outline: none;
            transition: 0.2s;
        }
        .raw-input:focus { border-color: white; }
        .input-group { margin-bottom: 20px; }
        .input-label { display: block; font-family: 'JetBrains Mono'; font-size: 9px; color: #666; margin-bottom: 6px; text-transform: uppercase; }

        /* UPLOAD ZONE */
        .drop-zone {
            border: 1px dashed #444; background: #050505; height: 200px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.2s; cursor: pointer;
        }
        .drop-zone:hover { border-color: var(--kemet-green); background: rgba(34, 197, 94, 0.05); }
        .drop-text { font-family: 'JetBrains Mono'; font-size: 10px; color: #666; margin-top: 10px; }

        /* TERMINAL LOG */
        .term-log {
            background: #000; border: 1px solid #222; height: 200px; overflow-y: auto; padding: 16px;
            font-family: 'JetBrains Mono'; font-size: 10px; color: #444; line-height: 1.6;
        }
        .log-entry { display: block; }
        .log-time { color: #333; margin-right: 8px; }
        .log-succ { color: var(--kemet-green); }
        .log-warn { color: var(--kemet-red); }

        /* BUTTONS */
        .action-btn {
            background: white; color: black; font-family: 'JetBrains Mono'; font-weight: 700; font-size: 11px;
            padding: 12px 24px; text-transform: uppercase; letter-spacing: 0.1em; transition: 0.2s; border: none; cursor: pointer;
        }
        .action-btn:hover { background: #ccc; }
        .btn-danger { background: #330000; color: #ff9999; border: 1px solid #660000; }
        .btn-danger:hover { background: #660000; color: white; }

        /* STATUS DOT */
        .live-dot { width: 8px; height: 8px; background: var(--kemet-green); border-radius: 50%; box-shadow: 0 0 10px var(--kemet-green); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } }

        /* LOGIN SCREEN */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }
        .login-form {
            background: #0a0a0a;
            border: 1px solid #222;
            padding: 40px;
            max-width: 400px;
            width: 100%;
        }
        .login-input {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            color: white;
            padding: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            margin-top: 8px;
        }
        .login-input:focus {
            outline: none;
            border-color: white;
        }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="login-screen">
        <div class="login-form">
            <h1 class="text-2xl font-black mb-6 font-mono">KEMET // ADMIN</h1>
            <p class="text-gray-400 text-sm mb-6">Sign in with your admin account</p>
            <input type="email" id="email-input" class="login-input" placeholder="Admin Email" autocomplete="email" />
            <input type="password" id="password-input" class="login-input mt-4" placeholder="Password"
                autocomplete="current-password" onkeypress="if(event.key === 'Enter') signIn()" />
            <button onclick="signIn()" class="action-btn w-full mt-4" id="signin-btn">
                SIGN IN
            </button>
            <p id="login-error" class="text-red-500 text-xs mt-4 hidden"></p>
        </div>
    </div>

    <!-- ADMIN PANEL (Hidden until authenticated) -->
    <div id="admin-panel" class="admin-grid hidden">
        
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="p-6 border-b border-gray-900 flex items-center gap-3">
                <div class="w-4 h-4 bg-white"></div>
                <span class="font-black tracking-tighter text-lg">ADMIN.</span>
            </div>

            <nav class="flex-1 py-4">
                <div class="px-6 mb-2 text-[9px] font-mono text-gray-700 uppercase">Mission_Control</div>
                <button class="nav-btn active w-full" onclick="switchTab('dashboard', this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    Dashboard
                </button>
                <button class="nav-btn w-full" onclick="switchTab('deploy', this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Deploy_Build
                </button>
                <button class="nav-btn w-full" onclick="switchTab('releases', this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    Release_History
                </button>
                <button class="nav-btn w-full" onclick="switchTab('users', this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    Node_Manager
                </button>
            </nav>

            <div class="p-6 border-t border-gray-900">
                <div class="flex items-center gap-2 mb-2">
                    <div class="live-dot"></div>
                    <span class="text-[10px] font-mono text-green-500 uppercase">System Online</span>
                </div>
                <div class="text-[10px] font-mono text-gray-600" id="server-info">
                    SERVER: US-EAST-1<br>
                    LATENCY: --ms
                </div>
                <button onclick="logout()" class="action-btn w-full mt-4 text-[9px] py-2 bg-red-900/20 text-red-400 border border-red-900 hover:bg-red-900/40">
                    LOGOUT
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="workspace">

            <!-- === TAB 1: DASHBOARD === -->
            <section id="dashboard" class="workspace-section active">
                <div class="panel-header">
                    <span>SYSTEM_OVERVIEW</span>
                    <button onclick="refreshDashboard()" class="action-btn text-[10px] px-3 py-2 bg-[#111] text-white border border-gray-800 hover:border-white">
                        REFRESH
                    </button>
                </div>

                <!-- STATS GRID -->
                <div class="grid grid-cols-4 gap-4 mb-8">
                    <div class="stat-card">
                        <span class="stat-lbl">Active Nodes</span>
                        <span class="stat-val" id="val-nodes">--</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-lbl">Total Downloads</span>
                        <span class="stat-val" id="val-downloads">--</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-lbl">Current Version</span>
                        <span class="stat-val text-green-500" id="val-version">--</span>
                    </div>
                    <div class="stat-card border-red-900/30 bg-red-900/5">
                        <span class="stat-lbl text-red-500">Flagged Signals</span>
                        <span class="stat-val text-red-500" id="val-flagged">--</span>
                    </div>
                </div>

                <!-- LIVE TERMINAL -->
                <div class="input-group">
                    <label class="input-label">Real-Time System Log</label>
                    <div class="term-log" id="system-log">
                        <div class="log-entry"><span class="log-time">[--:--:--]</span> <span>Initializing...</span></div>
                    </div>
                </div>
            </section>

            <!-- === TAB 2: DEPLOY (APK UPLOAD) === -->
            <section id="deploy" class="workspace-section">
                <div class="panel-header">
                    <span>INJECT_PAYLOAD (APK)</span>
                    <span class="text-[10px] font-mono text-gray-500">TARGET: LANDING_PAGE</span>
                </div>

                <div class="grid grid-cols-2 gap-8">
                    <!-- Left: Metadata -->
                    <div>
                        <div class="input-group">
                            <label class="input-label">Version Name</label>
                            <input type="text" id="deploy-version" class="raw-input" placeholder="e.g. 2.0.5">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Build Number</label>
                            <input type="text" id="deploy-build" class="raw-input" placeholder="e.g. 8493_A">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Android Min Version</label>
                            <input type="text" id="deploy-android" class="raw-input" value="10" placeholder="e.g. 10">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Release Type</label>
                            <select id="deploy-type" class="raw-input">
                                <option value="STABLE" selected>STABLE</option>
                                <option value="BETA">BETA</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">GitHub Release APK URL (Optional)</label>
                            <input type="url" id="deploy-url" class="raw-input" placeholder="Leave empty if uploading file above">
                            <p class="text-[9px] text-gray-500 mt-2">Upload file above OR paste existing GitHub release URL</p>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Release Notes (Optional)</label>
                            <textarea id="deploy-notes" class="raw-input h-32 resize-none" placeholder="What's new in this release..."></textarea>
                        </div>
                        <div class="input-group">
                            <label class="input-label">APK Size (Auto-calculated)</label>
                            <input type="text" id="deploy-size" class="raw-input" readonly placeholder="Will be calculated...">
                            <button onclick="calculateDeploySize()" class="action-btn mt-2 text-[10px] px-3 py-2">
                                CALCULATE SIZE
                            </button>
                        </div>
                    </div>

                    <!-- Right: Dropzone -->
                    <div>
                        <div class="input-group">
                            <label class="input-label">Binary File (.apk)</label>
                            <div class="drop-zone" id="dropArea" onclick="document.getElementById('file-input').click()" 
                                 ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="2" class="mb-4"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                <span class="text-xs font-bold text-white">CLICK TO UPLOAD</span>
                                <span class="drop-text">OR DRAG FILE HERE</span>
                            </div>
                            <input type="file" id="file-input" accept=".apk" style="display: none;" onchange="handleFileSelect(event)">
                            <div id="upload-progress" class="hidden mt-4">
                                <div class="flex justify-between text-[10px] font-mono text-gray-500 mb-1">
                                    <span id="upload-filename">Uploading...</span>
                                    <span id="prog-pct">0%</span>
                                </div>
                                <div class="w-full h-1 bg-gray-900"><div id="prog-bar" class="h-full bg-green-500 w-0 transition-all duration-300"></div></div>
                            </div>
                        </div>
                        
                        <button onclick="deployBuild()" class="action-btn w-full mt-4 flex justify-between items-center" id="deploy-btn">
                            <span>Push to Production</span>
                            <span>→</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- === TAB 3: RELEASE HISTORY === -->
            <section id="releases" class="workspace-section">
                <div class="panel-header">
                    <span>RELEASE_HISTORY</span>
                    <button onclick="loadReleaseHistory()" class="action-btn text-[10px] px-3 py-2 bg-[#111] text-white border border-gray-800 hover:border-white">
                        REFRESH
                    </button>
                </div>

                <div id="release-history-container" class="border border-gray-800">
                    <div class="grid grid-cols-6 p-3 bg-[#0a0a0a] border-b border-gray-800 text-[9px] font-mono text-gray-500 uppercase">
                        <span>Status</span>
                        <span>Version</span>
                        <span>Build</span>
                        <span>Android</span>
                        <span>Size</span>
                        <span class="text-right">Created</span>
                    </div>
                    <div id="release-history-list" class="text-gray-400">
                        <div class="p-4 text-center">Loading...</div>
                    </div>
                </div>
            </section>

            <!-- === TAB 4: USERS (NODES) === -->
            <section id="users" class="workspace-section">
                <div class="panel-header">
                    <span>NODE_MANAGER</span>
                    <div class="flex gap-2">
                        <input type="text" id="user-search" placeholder="SEARCH HANDLE / UID" class="raw-input w-64 bg-[#0a0a0a] border-gray-800" onkeyup="searchUsers(event)">
                    </div>
                </div>

                <!-- User Table -->
                <div class="border border-gray-800">
                    <div class="grid grid-cols-5 p-3 bg-[#0a0a0a] border-b border-gray-800 text-[9px] font-mono text-gray-500 uppercase">
                        <span class="col-span-2">Identity</span>
                        <span>Joined</span>
                        <span>Status</span>
                        <span class="text-right">Action</span>
                    </div>
                    
                    <div id="users-list" class="text-gray-400">
                        <div class="p-4 text-center">Loading...</div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script>
        // ============================================
        // SECURITY UTILITIES
        // ============================================
        function sanitize(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function safeUrl(url) {
            if (!url) return '';
            if (url.startsWith('http://') || url.startsWith('https://')) {
                return url.replace(/"/g, ''); 
            }
            return ''; 
        }

        // ============================================
        // CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://gqxsrxadgsehcwjhsgor.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdxeHNyeGFkZ3NlaGN3amhzZ29yIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM4MDQ3MTcsImV4cCI6MjA3OTM4MDcxN30.Z1JwUBXrUQ2bKuQdUt0coq3kn-UgfQUnePGluYfWJxA';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // UI HELPERS
        // ============================================
        const UI = {
            showLogin: () => {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-panel').classList.add('hidden');
                UI.resetButton();
            },
            showAdmin: () => {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
            },
            showError: (msg) => {
                const el = document.getElementById('login-error');
                if(el) { el.textContent = msg; el.classList.remove('hidden'); }
                UI.resetButton();
            },
            resetButton: () => {
                const btn = document.getElementById('signin-btn');
                if(btn) { btn.disabled = false; btn.textContent = 'SIGN IN'; }
            },
            setLoading: () => {
                const btn = document.getElementById('signin-btn');
                if(btn) { btn.disabled = true; btn.textContent = 'SIGNING IN...'; }
            }
        };

        // ============================================
        // SECURITY: Role Checks
        // ============================================
        async function checkAdminRole(userId) {
            try {
                // 1. Try Secure RPC first (Best)
                const { data: isRpcAdmin, error } = await supabase.rpc('is_admin');
                if (!error && isRpcAdmin === true) return true;

                // 2. Fallback to Metadata
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return false;
                
                // SECURITY FIX: CHECK app_metadata, NOT user_metadata
                return user.app_metadata?.role === 'admin';
            } catch (e) {
                console.error('Role check failed:', e);
                return false;
            }
        }

        // ============================================
        // MAIN ENTRY POINT
        // ============================================
        async function initApp() {
            // 1. Check current session immediately
            const { data: { session } } = await supabase.auth.getSession();

            if (session) {
                const isAdmin = await checkAdminRole(session.user.id);
                if (isAdmin) {
                    console.log("✅ Session restored. Welcome Admin.");
                    UI.showAdmin();
                    loadData(); 
                } else {
                    console.warn("⛔ User is logged in but NOT admin. Kicking out.");
                    await supabase.auth.signOut();
                    UI.showLogin();
                    UI.showError("Access Denied: Admin privileges required.");
                }
            } else {
                UI.showLogin();
            }
        }

        // ============================================
        // AUTH ACTIONS
        // ============================================
        async function signIn() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            const errorEl = document.getElementById('login-error');
            errorEl.classList.add('hidden');
            
            if (!email || !password) return UI.showError('Please enter email and password');

            UI.setLoading();

            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;

                const isAdmin = await checkAdminRole(data.user.id);
                if (!isAdmin) {
                    await supabase.auth.signOut(); 
                    throw new Error('This account is not an Admin.');
                }

                UI.showAdmin();
                loadData();

            } catch (err) {
                console.error("Login failed:", err);
                UI.showError(err.message || 'Login failed');
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.reload();
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================
        function switchTab(id, btn) {
            document.querySelectorAll('.workspace-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');

            if (id === 'dashboard') refreshDashboard();
            else if (id === 'releases') loadReleaseHistory();
            else if (id === 'users') loadUsers();
            else if (id === 'deploy') autoFillVersionAndBuild();
        }

        // ============================================
        // DATA LOADING
        // ============================================
        function loadData() {
            refreshDashboard();
            loadReleaseHistory();
            loadUsers();
            setInterval(refreshDashboard, 30000);
        }

        async function refreshDashboard() {
            try {
                const { data: userCount } = await supabase.rpc('get_user_count');
                const { data: stats } = await supabase.from('network_stats').select('*').eq('id', 1).maybeSingle();
                const { data: downloads } = await supabase.rpc('get_download_count');
                const { data: release } = await supabase.from('app_releases').select('version_name').eq('is_active', true).limit(1).maybeSingle();

                document.getElementById('val-nodes').textContent = (userCount || 0).toLocaleString();
                document.getElementById('val-downloads').textContent = (downloads || 0).toLocaleString();
                document.getElementById('val-version').textContent = release ? sanitize(release.version_name) : '--';
            } catch (e) { console.error(e); }
        }

        async function loadReleaseHistory() {
            try {
                const { data: releases, error } = await supabase
                    .from('app_releases')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (error) throw error;
                renderReleaseHistory(releases);
            } catch (error) { console.error(error); }
        }

        function renderReleaseHistory(releases) {
            const container = document.getElementById('release-history-list');
            if (!releases || releases.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">No releases yet</div>';
                return;
            }
            // SECURITY FIX: Sanitized outputs
            container.innerHTML = releases.map(release => `
                <div class="grid grid-cols-6 p-4 border-b border-gray-900 items-center hover:bg-[#0a0a0a] transition">
                    <div>
                        <span class="text-[9px] font-bold ${release.is_active ? 'bg-green-900/30 text-green-500 border border-green-800' : 'bg-gray-900/30 text-gray-500 border border-gray-800'} px-2 py-1">
                            ${release.is_active ? 'ACTIVE' : 'INACTIVE'}
                        </span>
                    </div>
                    <div class="text-xs font-bold text-white">${sanitize(release.version_name)}</div>
                    <div class="text-[10px] font-mono text-gray-400">${sanitize(release.build_number)}</div>
                    <div class="text-[10px] font-mono text-gray-400">${sanitize(release.android_min_version)}+</div>
                    <div class="text-[10px] font-mono text-gray-400">${release.apk_size_mb || 'N/A'}MB</div>
                    <div class="text-[10px] font-mono text-gray-500 text-right">${new Date(release.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        async function loadUsers(searchTerm = '') {
            try {
                let query = supabase
                    .from('public_profiles')
                    .select('id, handle, display_name, avatar_url, created_at')
                    .order('created_at', { ascending: false })
                    .limit(50);

                if (searchTerm) {
                    query = query.or(`handle.ilike.%${searchTerm}%,display_name.ilike.%${searchTerm}%`);
                }

                const { data: users, error } = await query;
                if (error) throw error;
                renderUsers(users);
            } catch (error) { console.error(error); }
        }

        function renderUsers(users) {
            const container = document.getElementById('users-list');
            if (!users || users.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">No users found</div>';
                return;
            }
            // SECURITY FIX: Sanitized outputs
            container.innerHTML = users.map(user => `
                <div class="grid grid-cols-5 p-4 border-b border-gray-900 items-center hover:bg-[#0a0a0a] transition">
                    <div class="col-span-2 flex items-center gap-3">
                        <div class="w-8 h-8 bg-gray-800 rounded-sm overflow-hidden">
                            <img src="${safeUrl(user.avatar_url) || 'https://via.placeholder.com/32'}" class="w-full h-full object-cover grayscale" onerror="this.src='https://via.placeholder.com/32';">
                        </div>
                        <div>
                            <div class="text-xs font-bold text-white">${sanitize(user.display_name) || 'Unknown'}</div>
                            <div class="text-[9px] font-mono text-gray-500">@${sanitize(user.handle) || 'unknown'}</div>
                        </div>
                    </div>
                    <div class="text-[10px] font-mono text-gray-400">${new Date(user.created_at).toLocaleDateString()}</div>
                    <div><span class="text-[9px] font-bold bg-green-900/30 text-green-500 px-1 border border-green-800">ACTIVE</span></div>
                    <div class="text-right"><button class="text-[9px] font-mono text-white underline hover:text-red-500">MANAGE</button></div>
                </div>
            `).join('');
        }

        function searchUsers(event) {
            const term = event.target.value.trim();
            if (term.length >= 2 || term.length === 0) loadUsers(term);
        }

        // ============================================
        // DEPLOY LOGIC
        // ============================================
        let selectedFile = null;
        const GITHUB_OWNER = 'yousseftameryty';
        const GITHUB_REPO = 'KemetCorp';

        function handleDragOver(event) { event.preventDefault(); event.currentTarget.style.borderColor = '#22c55e'; event.currentTarget.style.background = 'rgba(34, 197, 94, 0.1)'; }
        function handleDragLeave(event) { event.preventDefault(); event.currentTarget.style.borderColor = '#444'; event.currentTarget.style.background = '#050505'; }
        function handleDrop(event) {
            event.preventDefault(); event.currentTarget.style.borderColor = '#444'; event.currentTarget.style.background = '#050505';
            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.apk')) {
                const fakeEvent = { target: { files: [files[0]] } };
                handleFileSelect(fakeEvent);
            }
        }
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.name.endsWith('.apk')) {
                selectedFile = file;
                document.getElementById('deploy-size').value = `${(file.size / 1024 / 1024).toFixed(2)}MB`;
                document.getElementById('dropArea').innerHTML = `<span class="text-xs font-bold text-green-500">${sanitize(file.name)}</span>`;
            }
        }

        function generateVersionNumber() {
            const now = new Date();
            return `${now.getFullYear().toString().slice(-2)}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;
        }
        function generateBuildNumber() {
            const now = new Date();
            return `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
        }

        async function autoFillVersionAndBuild() {
            const verInput = document.getElementById('deploy-version');
            const buildInput = document.getElementById('deploy-build');
            if(!verInput.value) verInput.value = generateVersionNumber();
            if(!buildInput.value) buildInput.value = generateBuildNumber();
        }

        async function calculateDeploySize() {
            const url = document.getElementById('deploy-url').value;
            if(!url) return;
            try {
                const res = await fetch(url, { method: 'HEAD' });
                if(res.ok) document.getElementById('deploy-size').value = `${(parseInt(res.headers.get('content-length')) / 1048576).toFixed(2)}MB`;
            } catch(e) { console.error(e); }
        }

        async function deployBuild() {
            const btn = document.getElementById('deploy-btn');
            const version = document.getElementById('deploy-version').value;
            const build = document.getElementById('deploy-build').value;
            const apkUrl = document.getElementById('deploy-url').value || document.getElementById('post-deploy-url')?.value;
            
            if(!version || !build) return alert("Missing Version info");
            
            if(!apkUrl) {
                const releaseTag = `v${version}`;
                const ghUrl = `https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/releases/new?tag=${releaseTag}&title=KEMET%20${version}`;
                window.open(ghUrl, '_blank');
                let postDeploy = document.getElementById('post-deploy-interface');
                if (!postDeploy) {
                    postDeploy = document.createElement('div');
                    postDeploy.id = 'post-deploy-interface';
                    postDeploy.className = 'fixed inset-0 bg-black/80 flex items-center justify-center p-8';
                    postDeploy.innerHTML = `<div class="bg-black border border-gray-800 p-8 w-full max-w-lg"><input id="post-deploy-url" class="raw-input mb-4" placeholder="Paste APK URL"><button onclick="deployBuild()" class="action-btn w-full">CONFIRM</button></div>`;
                    document.body.appendChild(postDeploy);
                } else {
                    postDeploy.classList.remove('hidden');
                }
                return;
            }

            btn.innerText = "DEPLOYING...";
            
            try {
                await supabase.from('app_releases').update({ is_active: false }).eq('is_active', true);
                const { error } = await supabase.from('app_releases').insert({
                    version_name: version,
                    build_number: build,
                    android_min_version: document.getElementById('deploy-android').value,
                    apk_url: apkUrl,
                    apk_size_mb: parseFloat(document.getElementById('deploy-size').value.replace('MB','')),
                    release_notes: document.getElementById('deploy-notes').value,
                    release_type: document.getElementById('deploy-type').value,
                    is_active: true
                });

                if(error) throw error;
                btn.innerText = "SUCCESS";
                btn.style.backgroundColor = "#22c55e";
                document.getElementById('post-deploy-interface')?.classList.add('hidden');
                loadReleaseHistory();
            } catch(e) {
                console.error(e);
                alert("Deploy Failed: " + e.message);
                btn.innerText = "Push to Production";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('password-input')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') signIn();
            });
            initApp();
        });
    </script>
</body>
</html>