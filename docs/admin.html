<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KEMET // ADMIN_CONSOLE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="kemetadmin.png" type="image/x-icon">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { --kemet-green: #22c55e; --kemet-red: #ef4444; }
        body { background-color: #020202; color: #e5e5e5; font-family: 'Inter', sans-serif; overflow: hidden; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* === LAYOUT === */
        .admin-grid { display: grid; grid-template-columns: 260px 1fr; height: 100vh; }
        
        /* SIDEBAR */
        .sidebar { background: #000; border-right: 1px solid #222; display: flex; flex-direction: column; }
        .nav-btn {
            display: flex; align-items: center; gap: 12px; padding: 14px 24px;
            font-family: 'JetBrains Mono'; font-size: 11px; text-transform: uppercase; color: #666;
            transition: 0.2s; border-left: 2px solid transparent; cursor: pointer;
        }
        .nav-btn:hover, .nav-btn.active { background: #0a0a0a; color: white; }
        .nav-btn.active { border-left-color: var(--kemet-green); }

        /* MAIN AREA */
        .workspace { overflow-y: auto; padding: 40px; position: relative; }
        .workspace-section { display: none; animation: fadeIn 0.3s ease; }
        .workspace-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* DATA CARDS */
        .stat-card {
            background: #0a0a0a; border: 1px solid #222; padding: 20px;
            display: flex; flex-direction: column; justify-content: space-between; height: 120px;
        }
        .stat-val { font-size: 28px; font-weight: 900; letter-spacing: -0.05em; color: white; }
        .stat-lbl { font-family: 'JetBrains Mono'; font-size: 10px; color: #555; text-transform: uppercase; }

        /* INPUTS & FORMS */
        .panel-header { font-size: 24px; font-weight: 900; letter-spacing: -0.05em; margin-bottom: 30px; display: flex; justify-content: space-between; align-items: center; }
        
        .raw-input {
            width: 100%; background: #000; border: 1px solid #333; color: white;
            font-family: 'JetBrains Mono'; font-size: 12px; padding: 12px; outline: none;
            transition: 0.2s;
        }
        .raw-input:focus { border-color: white; }
        .input-group { margin-bottom: 20px; }
        .input-label { display: block; font-family: 'JetBrains Mono'; font-size: 9px; color: #666; margin-bottom: 6px; text-transform: uppercase; }

        /* UPLOAD ZONE */
        .drop-zone {
            border: 1px dashed #444; background: #050505; height: 200px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: 0.2s; cursor: pointer;
        }
        .drop-zone:hover { border-color: var(--kemet-green); background: rgba(34, 197, 94, 0.05); }
        .drop-text { font-family: 'JetBrains Mono'; font-size: 10px; color: #666; margin-top: 10px; }

        /* TERMINAL LOG */
        .term-log {
            background: #000; border: 1px solid #222; height: 200px; overflow-y: auto; padding: 16px;
            font-family: 'JetBrains Mono'; font-size: 10px; color: #444; line-height: 1.6;
        }
        .log-entry { display: block; }
        .log-time { color: #333; margin-right: 8px; }
        .log-succ { color: var(--kemet-green); }
        .log-warn { color: var(--kemet-red); }

        /* BUTTONS */
        .action-btn {
            background: white; color: black; font-family: 'JetBrains Mono'; font-weight: 700; font-size: 11px;
            padding: 12px 24px; text-transform: uppercase; letter-spacing: 0.1em; transition: 0.2s; border: none; cursor: pointer;
        }
        .action-btn:hover { background: #ccc; }
        .btn-danger { background: #330000; color: #ff9999; border: 1px solid #660000; }
        .btn-danger:hover { background: #660000; color: white; }

        /* STATUS DOT */
        .live-dot { width: 8px; height: 8px; background: var(--kemet-green); border-radius: 50%; box-shadow: 0 0 10px var(--kemet-green); animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } }

        /* LOGIN SCREEN */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #000;
        }
        .login-form {
            background: #0a0a0a;
            border: 1px solid #222;
            padding: 40px;
            max-width: 400px;
            width: 100%;
        }
        .login-input {
            width: 100%;
            background: #000;
            border: 1px solid #333;
            color: white;
            padding: 12px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
            margin-top: 8px;
        }
        .login-input:focus {
            outline: none;
            border-color: white;
        }

        /* MODERATION TABS */
        .mod-tab-btn {
            cursor: pointer;
            transition: 0.2s;
        }
        .mod-tab-btn.active {
            color: white;
            border-bottom-color: white !important;
        }
        .moderation-subsection {
            display: block;
        }
        .moderation-subsection.hidden {
            display: none;
        }
    </style>
</head>
<body>

    <!-- LOGIN SCREEN -->
    <div id="login-screen" class="login-screen">
        <div class="login-form">
            <h1 class="text-2xl font-black mb-6 font-mono">KEMET // ADMIN</h1>
            <p class="text-gray-400 text-sm mb-6">Sign in with your admin account</p>
            <input type="email" id="email-input" class="login-input" placeholder="Admin Email" autocomplete="email" />
            <input type="password" id="password-input" class="login-input mt-4" placeholder="Password"
                autocomplete="current-password" onkeypress="if(event.key === 'Enter') signIn()" />
            <button onclick="signIn()" class="action-btn w-full mt-4" id="signin-btn">
                SIGN IN
            </button>
            <p id="login-error" class="text-red-500 text-xs mt-4 hidden"></p>
        </div>
    </div>

    <!-- ADMIN PANEL (Hidden until authenticated) -->
    <div id="admin-panel" class="admin-grid hidden">
        
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="p-6 border-b border-gray-900 flex items-center gap-3">
                <div class="w-4 h-4 bg-white"></div>
                <span class="font-black tracking-tighter text-lg">ADMIN.</span>
            </div>

            <nav class="flex-1 py-4">
                <div class="px-6 mb-2 text-[9px] font-mono text-gray-700 uppercase">Mission_Control</div>
                <button class="nav-btn active w-full" onclick="switchTab('dashboard', this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
                    Dashboard
                </button>
                <button class="nav-btn w-full" onclick="switchTab('deploy', this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    Deploy_Build
                </button>
                <button class="nav-btn w-full" onclick="switchTab('releases', this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    Release_History
                </button>
                <button class="nav-btn w-full" onclick="switchTab('users', this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    Node_Manager
                </button>
                <button class="nav-btn w-full" onclick="switchTab('moderation', this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                    Moderation
                </button>
                <div class="px-6 mb-2 mt-4 text-[9px] font-mono text-gray-700 uppercase">Database</div>
                <button class="nav-btn w-full" onclick="switchTab('database', this)">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>
                    Database_Control
                </button>
            </nav>

            <div class="p-6 border-t border-gray-900">
                <div class="flex items-center gap-2 mb-2">
                    <div class="live-dot"></div>
                    <span class="text-[10px] font-mono text-green-500 uppercase">System Online</span>
                </div>
                <div class="text-[10px] font-mono text-gray-600" id="server-info">
                    SERVER: US-EAST-1<br>
                    LATENCY: --ms
                </div>
                <button onclick="logout()" class="action-btn w-full mt-4 text-[9px] py-2 bg-red-900/20 text-red-400 border border-red-900 hover:bg-red-900/40">
                    LOGOUT
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="workspace">

            <!-- === TAB 1: DASHBOARD === -->
            <section id="dashboard" class="workspace-section active">
                <div class="panel-header">
                    <span>SYSTEM_OVERVIEW</span>
                    <button onclick="refreshDashboard()" class="action-btn text-[10px] px-3 py-2 bg-[#111] text-white border border-gray-800 hover:border-white">
                        REFRESH
                    </button>
                </div>

                <!-- STATS GRID -->
                <div class="grid grid-cols-4 gap-4 mb-8">
                    <div class="stat-card">
                        <span class="stat-lbl">Active Nodes</span>
                        <span class="stat-val" id="val-nodes">--</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-lbl">Total Downloads</span>
                        <span class="stat-val" id="val-downloads">--</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-lbl">Current Version</span>
                        <span class="stat-val text-green-500" id="val-version">--</span>
                    </div>
                    <div class="stat-card border-red-900/30 bg-red-900/5">
                        <span class="stat-lbl text-red-500">Flagged Signals</span>
                        <span class="stat-val text-red-500" id="val-flagged">--</span>
                    </div>
                </div>

                <!-- LIVE TERMINAL -->
                <div class="input-group">
                    <label class="input-label">Real-Time System Log</label>
                    <div class="term-log" id="system-log">
                        <div class="log-entry"><span class="log-time">[--:--:--]</span> <span>Initializing...</span></div>
                    </div>
                </div>
            </section>

            <!-- === TAB 2: DEPLOY (APK UPLOAD) === -->
            <section id="deploy" class="workspace-section">
                <div class="panel-header">
                    <span>INJECT_PAYLOAD (APK)</span>
                    <span class="text-[10px] font-mono text-gray-500">TARGET: LANDING_PAGE</span>
                </div>

                <div class="grid grid-cols-2 gap-8">
                    <!-- Left: Metadata -->
                    <div>
                        <div class="input-group">
                            <label class="input-label">Version Name</label>
                            <input type="text" id="deploy-version" class="raw-input" placeholder="e.g. 2.0.5">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Build Number</label>
                            <input type="text" id="deploy-build" class="raw-input" placeholder="e.g. 8493_A">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Android Min Version</label>
                            <input type="text" id="deploy-android" class="raw-input" value="10" placeholder="e.g. 10">
                        </div>
                        <div class="input-group">
                            <label class="input-label">Release Type</label>
                            <select id="deploy-type" class="raw-input">
                                <option value="STABLE" selected>STABLE</option>
                                <option value="BETA">BETA</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="input-label">GitHub Release APK URL (Optional)</label>
                            <input type="url" id="deploy-url" class="raw-input" placeholder="Leave empty if uploading file above">
                            <p class="text-[9px] text-gray-500 mt-2">Upload file above OR paste existing GitHub release URL</p>
                        </div>
                        <div class="input-group">
                            <label class="input-label">Release Notes (Optional)</label>
                            <textarea id="deploy-notes" class="raw-input h-32 resize-none" placeholder="What's new in this release..."></textarea>
                        </div>
                        <div class="input-group">
                            <label class="input-label">APK Size (Auto-calculated)</label>
                            <input type="text" id="deploy-size" class="raw-input" readonly placeholder="Will be calculated...">
                            <button onclick="calculateDeploySize()" class="action-btn mt-2 text-[10px] px-3 py-2">
                                CALCULATE SIZE
                            </button>
                        </div>
                    </div>

                    <!-- Right: Dropzone -->
                    <div>
                        <div class="input-group">
                            <label class="input-label">Binary File (.apk)</label>
                            <div class="drop-zone" id="dropArea" onclick="document.getElementById('file-input').click()" 
                                 ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#444" stroke-width="2" class="mb-4"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                <span class="text-xs font-bold text-white">CLICK TO UPLOAD</span>
                                <span class="drop-text">OR DRAG FILE HERE</span>
                            </div>
                            <input type="file" id="file-input" accept=".apk" style="display: none;" onchange="handleFileSelect(event)">
                            <div id="upload-progress" class="hidden mt-4">
                                <div class="flex justify-between text-[10px] font-mono text-gray-500 mb-1">
                                    <span id="upload-filename">Uploading...</span>
                                    <span id="prog-pct">0%</span>
                                </div>
                                <div class="w-full h-1 bg-gray-900"><div id="prog-bar" class="h-full bg-green-500 w-0 transition-all duration-300"></div></div>
                            </div>
                        </div>
                        
                        <button onclick="deployBuild()" class="action-btn w-full mt-4 flex justify-between items-center" id="deploy-btn">
                            <span>Push to Production</span>
                            <span>→</span>
                        </button>
                    </div>
                </div>
            </section>

            <!-- === TAB 3: RELEASE HISTORY === -->
            <section id="releases" class="workspace-section">
                <div class="panel-header">
                    <span>RELEASE_HISTORY</span>
                    <button onclick="loadReleaseHistory()" class="action-btn text-[10px] px-3 py-2 bg-[#111] text-white border border-gray-800 hover:border-white">
                        REFRESH
                    </button>
                </div>

                <div id="release-history-container" class="border border-gray-800">
                    <div class="grid grid-cols-6 p-3 bg-[#0a0a0a] border-b border-gray-800 text-[9px] font-mono text-gray-500 uppercase">
                        <span>Status</span>
                        <span>Version</span>
                        <span>Build</span>
                        <span>Android</span>
                        <span>Size</span>
                        <span class="text-right">Created</span>
                    </div>
                    <div id="release-history-list" class="text-gray-400">
                        <div class="p-4 text-center">Loading...</div>
                    </div>
                </div>
            </section>

            <!-- === TAB 4: USERS (NODES) === -->
            <section id="users" class="workspace-section">
                <div class="panel-header">
                    <span>NODE_MANAGER</span>
                    <div class="flex gap-2">
                        <input type="text" id="user-search" placeholder="SEARCH HANDLE / UID" class="raw-input w-64 bg-[#0a0a0a] border-gray-800" onkeyup="searchUsers(event)">
                    </div>
                </div>

                <!-- User Table -->
                <div class="border border-gray-800">
                    <div class="grid grid-cols-5 p-3 bg-[#0a0a0a] border-b border-gray-800 text-[9px] font-mono text-gray-500 uppercase">
                        <span class="col-span-2">Identity</span>
                        <span>Joined</span>
                        <span>Status</span>
                        <span class="text-right">Action</span>
                    </div>
                    
                    <div id="users-list" class="text-gray-400">
                        <div class="p-4 text-center">Loading...</div>
                    </div>
                </div>
            </section>

            <!-- === TAB 5: MODERATION === -->
            <section id="moderation" class="workspace-section">
                <div class="panel-header">
                    <span>MODERATION_CONTROL</span>
                    <div class="flex gap-2">
                        <button onclick="loadAppeals()" class="action-btn text-[10px] px-3 py-2 bg-[#111] text-white border border-gray-800 hover:border-white">
                            REFRESH APPEALS
                        </button>
                        <button onclick="loadViolationReasons()" class="action-btn text-[10px] px-3 py-2 bg-[#111] text-white border border-gray-800 hover:border-white">
                            MANAGE REASONS
                        </button>
                    </div>
                </div>

                <!-- Moderation Stats -->
                <div class="grid grid-cols-4 gap-4 mb-6">
                    <div class="stat-card">
                        <span class="stat-lbl">Pending Appeals</span>
                        <span class="stat-val" id="stat-pending-appeals">--</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-lbl">Banned Users</span>
                        <span class="stat-val text-red-500" id="stat-banned-users">--</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-lbl">Restricted Users</span>
                        <span class="stat-val text-yellow-500" id="stat-restricted-users">--</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-lbl">Total Strikes Today</span>
                        <span class="stat-val" id="stat-strikes-today">--</span>
                    </div>
                </div>

                <!-- Tabs for moderation sections -->
                <div class="flex gap-2 mb-6 border-b border-gray-800">
                    <button onclick="switchModerationTab('appeals', this)" class="mod-tab-btn active px-4 py-2 text-[10px] font-mono uppercase border-b-2 border-white">
                        Appeals Queue
                    </button>
                    <button onclick="switchModerationTab('reasons', this)" class="mod-tab-btn px-4 py-2 text-[10px] font-mono uppercase border-b-2 border-transparent text-gray-500">
                        Violation Reasons
                    </button>
                    <button onclick="switchModerationTab('users', this)" class="mod-tab-btn px-4 py-2 text-[10px] font-mono uppercase border-b-2 border-transparent text-gray-500">
                        User Management
                    </button>
                </div>

                <!-- Appeals Queue -->
                <div id="mod-appeals" class="moderation-subsection">
                    <div class="border border-gray-800">
                        <div class="grid grid-cols-6 p-3 bg-[#0a0a0a] border-b border-gray-800 text-[9px] font-mono text-gray-500 uppercase">
                            <span>User</span>
                            <span>Ban Reason</span>
                            <span>Appeal Message</span>
                            <span>Status</span>
                            <span>Created</span>
                            <span class="text-right">Actions</span>
                        </div>
                        <div id="appeals-list" class="text-gray-400">
                            <div class="p-4 text-center">Loading appeals...</div>
                        </div>
                    </div>
                </div>

                <!-- Violation Reasons -->
                <div id="mod-reasons" class="moderation-subsection hidden">
                    <div class="mb-4">
                        <button onclick="createViolationReason()" class="action-btn text-[10px] px-4 py-2">
                            + ADD NEW REASON
                        </button>
                    </div>
                    <div class="border border-gray-800">
                        <div class="grid grid-cols-4 p-3 bg-[#0a0a0a] border-b border-gray-800 text-[9px] font-mono text-gray-500 uppercase">
                            <span>Name</span>
                            <span>Description</span>
                            <span>Default Message</span>
                            <span class="text-right">Actions</span>
                        </div>
                        <div id="violation-reasons-list" class="text-gray-400">
                            <div class="p-4 text-center">Loading violation reasons...</div>
                        </div>
                    </div>
                </div>

                <!-- User Management -->
                <div id="mod-users" class="moderation-subsection hidden">
                    <div class="border border-gray-800">
                        <div class="grid grid-cols-5 p-3 bg-[#0a0a0a] border-b border-gray-800 text-[9px] font-mono text-gray-500 uppercase">
                            <span>User</span>
                            <span>Strikes</span>
                            <span>Status</span>
                            <span>Restriction Expires</span>
                            <span class="text-right">Actions</span>
                        </div>
                        <div id="moderation-users-list" class="text-gray-400">
                            <div class="p-4 text-center">Loading users...</div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- === TAB 6: DATABASE CONTROL === -->
            <section id="database" class="workspace-section">
                <div class="panel-header">
                    <span>DATABASE_CONTROL</span>
                    <div class="flex gap-2">
                        <button onclick="loadDatabaseTables()" class="action-btn text-[10px] px-3 py-2 bg-[#111] text-white border border-gray-800 hover:border-white">
                            REFRESH
                        </button>
                        <button onclick="showSQLQuery()" class="action-btn text-[10px] px-3 py-2 bg-[#111] text-white border border-gray-800 hover:border-white">
                            SQL QUERY
                        </button>
                    </div>
                </div>

                <!-- Database Tables List -->
                <div class="mb-6">
                    <div class="text-sm font-mono text-gray-400 mb-2">AVAILABLE TABLES</div>
                    <div id="database-tables-list" class="border border-gray-800">
                        <div class="p-4 text-center text-gray-500">Loading tables...</div>
                    </div>
                </div>

                <!-- Table Data Viewer -->
                <div id="table-viewer" class="hidden">
                    <div class="panel-header">
                        <span id="table-viewer-name">TABLE_NAME</span>
                        <div class="flex gap-2">
                            <button onclick="refreshTableViewer()" class="action-btn text-[10px] px-3 py-2 bg-[#111] text-white border border-gray-800">
                                REFRESH
                            </button>
                            <button onclick="closeTableViewer()" class="action-btn text-[10px] px-3 py-2 bg-red-900/20 text-red-400 border border-red-900">
                                CLOSE
                            </button>
                        </div>
                    </div>
                    <div id="table-viewer-content" class="border border-gray-800 overflow-x-auto">
                        <div class="p-4 text-center text-gray-500">Loading data...</div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <script>
        // ============================================
        // SECURITY UTILITIES
        // ============================================
        function sanitize(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }

        function safeUrl(url) {
            if (!url) return '';
            if (url.startsWith('http://') || url.startsWith('https://')) {
                return url.replace(/"/g, ''); 
            }
            return ''; 
        }

        // ============================================
        // CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://gqxsrxadgsehcwjhsgor.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_Zb-UfacK3yWOkg2XDo3z6A_R3yXVo6E';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ============================================
        // UI HELPERS
        // ============================================
        const UI = {
            showLogin: () => {
                document.getElementById('login-screen').classList.remove('hidden');
                document.getElementById('admin-panel').classList.add('hidden');
                UI.resetButton();
            },
            showAdmin: () => {
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('admin-panel').classList.remove('hidden');
            },
            showError: (msg) => {
                const el = document.getElementById('login-error');
                if(el) { el.textContent = msg; el.classList.remove('hidden'); }
                UI.resetButton();
            },
            resetButton: () => {
                const btn = document.getElementById('signin-btn');
                if(btn) { btn.disabled = false; btn.textContent = 'SIGN IN'; }
            },
            setLoading: () => {
                const btn = document.getElementById('signin-btn');
                if(btn) { btn.disabled = true; btn.textContent = 'SIGNING IN...'; }
            }
        };

        // ============================================
        // SECURITY: Role Checks
        // ============================================
        async function checkAdminRole(userId) {
            try {
                // 1. Try Secure RPC first (Best)
                const { data: isRpcAdmin, error } = await supabase.rpc('is_admin');
                if (!error && isRpcAdmin === true) return true;

                // 2. Fallback to Metadata
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) return false;
                
                // SECURITY FIX: CHECK app_metadata, NOT user_metadata
                return user.app_metadata?.role === 'admin';
            } catch (e) {
                console.error('Role check failed:', e);
                return false;
            }
        }

        // ============================================
        // MAIN ENTRY POINT
        // ============================================
        async function initApp() {
            // 1. Check current session immediately
            const { data: { session } } = await supabase.auth.getSession();

            if (session) {
                const isAdmin = await checkAdminRole(session.user.id);
                if (isAdmin) {
                    console.log("✅ Session restored. Welcome Admin.");
                    UI.showAdmin();
                    loadData(); 
                } else {
                    console.warn("⛔ User is logged in but NOT admin. Kicking out.");
                    await supabase.auth.signOut();
                    UI.showLogin();
                    UI.showError("Access Denied: Admin privileges required.");
                }
            } else {
                UI.showLogin();
            }
        }

        // ============================================
        // AUTH ACTIONS
        // ============================================
        async function signIn() {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            const errorEl = document.getElementById('login-error');
            errorEl.classList.add('hidden');
            
            if (!email || !password) return UI.showError('Please enter email and password');

            UI.setLoading();

            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });
                if (error) throw error;

                const isAdmin = await checkAdminRole(data.user.id);
                if (!isAdmin) {
                    await supabase.auth.signOut(); 
                    throw new Error('This account is not an Admin.');
                }

                UI.showAdmin();
                loadData();

            } catch (err) {
                console.error("Login failed:", err);
                UI.showError(err.message || 'Login failed');
            }
        }

        async function logout() {
            await supabase.auth.signOut();
            window.location.reload();
        }

        // ============================================
        // TAB NAVIGATION
        // ============================================
        function switchTab(id, btn) {
            document.querySelectorAll('.workspace-section').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(id).classList.add('active');
            btn.classList.add('active');

            if (id === 'dashboard') refreshDashboard();
            else if (id === 'releases') loadReleaseHistory();
            else if (id === 'users') loadUsers();
            else if (id === 'deploy') autoFillVersionAndBuild();
            else if (id === 'moderation') {
                loadModerationStats();
                loadAppeals();
                loadViolationReasons();
                loadModerationUsers();
            }
            else if (id === 'database') {
                loadDatabaseTables();
            }
        }

        // ============================================
        // MODERATION FUNCTIONS
        // ============================================
        function switchModerationTab(id, btn) {
            document.querySelectorAll('.moderation-subsection').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.mod-tab-btn').forEach(el => el.classList.remove('active'));
            
            document.getElementById(`mod-${id}`).classList.remove('hidden');
            btn.classList.add('active');
        }

        async function loadModerationStats() {
            try {
                // Use admin RPC function to get all stats at once
                const { data: stats, error } = await supabase.rpc('admin_get_moderation_stats');
                
                if (error) throw error;
                
                const statsData = stats?.[0] || {};
                document.getElementById('stat-pending-appeals').textContent = statsData.pending_appeals || 0;
                document.getElementById('stat-banned-users').textContent = statsData.banned_users || 0;
                document.getElementById('stat-restricted-users').textContent = statsData.restricted_users || 0;
                document.getElementById('stat-strikes-today').textContent = statsData.strikes_today || 0;
            } catch (error) {
                console.error('Error loading moderation stats:', error);
                // Fallback to 0 if RPC fails
                document.getElementById('stat-pending-appeals').textContent = '0';
                document.getElementById('stat-banned-users').textContent = '0';
                document.getElementById('stat-restricted-users').textContent = '0';
                document.getElementById('stat-strikes-today').textContent = '0';
            }
        }

        async function loadAppeals() {
            try {
                // Use admin RPC function to bypass RLS
                const { data: appeals, error } = await supabase.rpc('admin_get_appeals');

                if (error) throw error;
                renderAppeals(appeals || []);
            } catch (error) {
                console.error('Error loading appeals:', error);
                document.getElementById('appeals-list').innerHTML = `<div class="p-4 text-center text-red-500">Error loading appeals: ${error.message}</div>`;
            }
        }

        function renderAppeals(appeals) {
            const container = document.getElementById('appeals-list');
            if (!appeals || appeals.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">No appeals pending</div>';
                return;
            }

            container.innerHTML = appeals.map(appeal => {
                const statusColor = {
                    'pending': '#6b7280',
                    'under_review': '#f59e0b',
                    'approved': '#10b981',
                    'rejected': '#ef4444'
                }[appeal.status] || '#6b7280';

                return `
                    <div class="grid grid-cols-6 p-4 border-b border-gray-900 items-center hover:bg-[#0a0a0a] transition">
                        <div>
                            <div class="text-xs font-bold text-white">${sanitize(appeal.user_display_name || 'Unknown')}</div>
                            <div class="text-[9px] font-mono text-gray-500">@${sanitize(appeal.user_handle || 'unknown')}</div>
                        </div>
                        <div class="text-[10px] font-mono text-gray-400">${sanitize(appeal.ban_reason || 'N/A')}</div>
                        <div class="text-[10px] font-mono text-gray-400 truncate" title="${sanitize(appeal.appeal_message || '')}">${sanitize((appeal.appeal_message || '').substring(0, 50))}${appeal.appeal_message && appeal.appeal_message.length > 50 ? '...' : ''}</div>
                        <div>
                            <span class="text-[9px] font-bold px-2 py-1" style="background-color: ${statusColor}20; color: ${statusColor}; border: 1px solid ${statusColor}40;">
                                ${(appeal.status || 'pending').toUpperCase()}
                            </span>
                        </div>
                        <div class="text-[10px] font-mono text-gray-500">${new Date(appeal.created_at).toLocaleDateString()}</div>
                        <div class="text-right">
                            ${appeal.status === 'pending' ? `
                                <button onclick="approveAppeal('${appeal.id}')" class="text-[9px] font-mono text-green-500 underline hover:text-green-400 mr-2">APPROVE</button>
                                <button onclick="rejectAppeal('${appeal.id}')" class="text-[9px] font-mono text-red-500 underline hover:text-red-400">REJECT</button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function approveAppeal(appealId) {
            const reviewNotes = prompt('Enter review notes (optional):', '');
            if (reviewNotes === null) return; // User cancelled

            if (!confirm('Are you sure you want to approve this appeal? This will unban the user.')) return;

            try {
                // Use admin RPC function to bypass RLS and foreign key issues
                const { error } = await supabase.rpc('admin_update_appeal', {
                    p_appeal_id: appealId,
                    p_status: 'approved',
                    p_review_notes: reviewNotes || null
                });

                if (error) {
                    if (error.message.includes('already processed') || error.message.includes('not found')) {
                        alert('Appeal may have already been processed. Refreshing...');
                        loadAppeals();
                        return;
                    }
                    throw error;
                }

                // Wait a moment for trigger to process
                await new Promise(resolve => setTimeout(resolve, 500));

                loadAppeals();
                loadModerationStats();
                alert('Appeal approved. User account has been restored.');
            } catch (error) {
                console.error('Error approving appeal:', error);
                alert('Error approving appeal: ' + (error.message || 'Unknown error'));
            }
        }

        async function rejectAppeal(appealId) {
            const reviewNotes = prompt('Enter rejection reason (optional):', '');
            if (reviewNotes === null) return; // User cancelled

            if (!confirm('Are you sure you want to reject this appeal? The user will remain banned.')) return;

            try {
                // Use admin RPC function to bypass RLS and foreign key issues
                const { error } = await supabase.rpc('admin_update_appeal', {
                    p_appeal_id: appealId,
                    p_status: 'rejected',
                    p_review_notes: reviewNotes || null
                });

                if (error) throw error;
                loadAppeals();
                loadModerationStats();
                alert('Appeal rejected.');
            } catch (error) {
                console.error('Error rejecting appeal:', error);
                alert('Error rejecting appeal: ' + (error.message || 'Unknown error'));
            }
        }

        async function loadViolationReasons() {
            try {
                const { data: reasons, error } = await supabase
                    .from('violation_reasons')
                    .select('*')
                    .order('name', { ascending: true });

                if (error) throw error;
                renderViolationReasons(reasons || []);
            } catch (error) {
                console.error('Error loading violation reasons:', error);
                document.getElementById('violation-reasons-list').innerHTML = '<div class="p-4 text-center text-red-500">Error loading violation reasons</div>';
            }
        }

        function renderViolationReasons(reasons) {
            const container = document.getElementById('violation-reasons-list');
            if (!reasons || reasons.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">No violation reasons found</div>';
                return;
            }

            container.innerHTML = reasons.map(reason => `
                <div class="grid grid-cols-4 p-4 border-b border-gray-900 items-center hover:bg-[#0a0a0a] transition">
                    <div class="text-xs font-bold text-white">${sanitize(reason.name)}</div>
                    <div class="text-[10px] font-mono text-gray-400">${sanitize(reason.description || 'N/A')}</div>
                    <div class="text-[10px] font-mono text-gray-400">${sanitize(reason.default_message || 'N/A')}</div>
                    <div class="text-right">
                        <button onclick="editViolationReason(${reason.id})" class="text-[9px] font-mono text-white underline hover:text-gray-400">EDIT</button>
                    </div>
                </div>
            `).join('');
        }

        async function loadModerationUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('id, handle, display_name, strike_count, account_status, restriction_expiration_date')
                    .in('account_status', ['restricted', 'banned'])
                    .order('strike_count', { ascending: false })
                    .limit(50);

                if (error) throw error;
                renderModerationUsers(users || []);
            } catch (error) {
                console.error('Error loading moderation users:', error);
                document.getElementById('moderation-users-list').innerHTML = '<div class="p-4 text-center text-red-500">Error loading users</div>';
            }
        }

        function renderModerationUsers(users) {
            const container = document.getElementById('moderation-users-list');
            if (!users || users.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">No restricted or banned users</div>';
                return;
            }

            container.innerHTML = users.map(user => {
                const statusColor = user.account_status === 'banned' ? '#ef4444' : '#f59e0b';
                const expirationDate = user.restriction_expiration_date 
                    ? new Date(user.restriction_expiration_date).toLocaleDateString()
                    : 'N/A';

                return `
                    <div class="grid grid-cols-5 p-4 border-b border-gray-900 items-center hover:bg-[#0a0a0a] transition">
                        <div>
                            <div class="text-xs font-bold text-white">${sanitize(user.display_name || 'Unknown')}</div>
                            <div class="text-[9px] font-mono text-gray-500">@${sanitize(user.handle || 'unknown')}</div>
                        </div>
                        <div class="text-[10px] font-mono text-gray-400">${user.strike_count || 0}/3</div>
                        <div>
                            <span class="text-[9px] font-bold px-2 py-1" style="background-color: ${statusColor}20; color: ${statusColor}; border: 1px solid ${statusColor}40;">
                                ${user.account_status.toUpperCase()}
                            </span>
                        </div>
                        <div class="text-[10px] font-mono text-gray-400">${expirationDate}</div>
                        <div class="text-right">
                            <button onclick="manageUser('${user.id}')" class="text-[9px] font-mono text-white underline hover:text-gray-400">MANAGE</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function manageUser(userId) {
            try {
                // Get user details
                const { data: user, error: userError } = await supabase
                    .from('users')
                    .select('id, handle, display_name, strike_count, account_status, restriction_expiration_date, created_at')
                    .eq('id', userId)
                    .single();

                if (userError) throw userError;

                // Get user's strike history
                const { data: strikeHistory } = await supabase
                    .from('account_status_logs')
                    .select('*')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(10);

                // Create modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center p-8 z-50';
                modal.innerHTML = `
                    <div class="bg-black border border-gray-800 p-8 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-black font-mono">USER MANAGEMENT</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-white text-2xl">&times;</button>
                        </div>
                        
                        <div class="mb-6">
                            <div class="text-sm font-mono text-gray-400 mb-2">USER INFO</div>
                            <div class="bg-[#0a0a0a] border border-gray-800 p-4">
                                <div class="text-white font-bold">${sanitize(user.display_name || 'Unknown')}</div>
                                <div class="text-gray-400 text-sm">@${sanitize(user.handle || 'unknown')}</div>
                                <div class="text-gray-500 text-xs mt-2">ID: ${user.id}</div>
                                <div class="text-gray-500 text-xs">Joined: ${new Date(user.created_at).toLocaleDateString()}</div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <div class="text-sm font-mono text-gray-400 mb-2">CURRENT STATUS</div>
                            <div class="bg-[#0a0a0a] border border-gray-800 p-4 grid grid-cols-3 gap-4">
                                <div>
                                    <div class="text-gray-500 text-xs">Strikes</div>
                                    <div class="text-white font-bold">${user.strike_count || 0}/3</div>
                                </div>
                                <div>
                                    <div class="text-gray-500 text-xs">Status</div>
                                    <div class="text-white font-bold">${user.account_status.toUpperCase()}</div>
                                </div>
                                <div>
                                    <div class="text-gray-500 text-xs">Restriction Expires</div>
                                    <div class="text-white font-bold">${user.restriction_expiration_date ? new Date(user.restriction_expiration_date).toLocaleString() : 'N/A'}</div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-6">
                            <div class="text-sm font-mono text-gray-400 mb-2">STRIKE HISTORY</div>
                            <div class="bg-[#0a0a0a] border border-gray-800 p-4 max-h-48 overflow-y-auto">
                                ${strikeHistory && strikeHistory.length > 0 ? strikeHistory.map(strike => `
                                    <div class="border-b border-gray-900 pb-2 mb-2">
                                        <div class="text-white text-xs">Strike ${strike.strike_number} - ${strike.violation_type || 'N/A'}</div>
                                        <div class="text-gray-500 text-[10px]">${strike.action_taken} - ${new Date(strike.created_at).toLocaleString()}</div>
                                    </div>
                                `).join('') : '<div class="text-gray-500 text-xs">No strike history</div>'}
                            </div>
                        </div>

                        <div class="mb-6">
                            <div class="text-sm font-mono text-gray-400 mb-2">ACTIONS</div>
                            <div class="grid grid-cols-2 gap-4">
                                <button onclick="adjustUserStrikes('${userId}', ${user.strike_count || 0})" class="action-btn text-[10px] py-2">
                                    ADJUST STRIKES
                                </button>
                                ${user.account_status === 'banned' ? `
                                    <button onclick="unbanUser('${userId}')" class="action-btn text-[10px] py-2 bg-green-900/20 text-green-400 border border-green-900">
                                        UNBAN USER
                                    </button>
                                ` : ''}
                                ${user.account_status === 'restricted' ? `
                                    <button onclick="removeRestriction('${userId}')" class="action-btn text-[10px] py-2 bg-green-900/20 text-green-400 border border-green-900">
                                        REMOVE RESTRICTION
                                    </button>
                                ` : ''}
                                <button onclick="addManualStrike('${userId}')" class="action-btn text-[10px] py-2 bg-red-900/20 text-red-400 border border-red-900">
                                    ADD MANUAL STRIKE
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading user details:', error);
                alert('Error loading user details: ' + error.message);
            }
        }

        async function adjustUserStrikes(userId, currentStrikes) {
            const newStrikes = prompt(`Current strikes: ${currentStrikes}/3\nEnter new strike count (0-3):`, currentStrikes);
            if (newStrikes === null) return;
            
            const strikes = parseInt(newStrikes);
            if (isNaN(strikes) || strikes < 0 || strikes > 3) {
                alert('Invalid strike count. Must be between 0 and 3.');
                return;
            }

            if (!confirm(`Are you sure you want to set strikes to ${strikes}? This will update the user's account status.`)) return;

            try {
                let newStatus = 'active';
                let restrictionExpiration = null;

                if (strikes >= 3) {
                    newStatus = 'banned';
                } else if (strikes >= 2) {
                    newStatus = 'restricted';
                    const d = new Date();
                    d.setHours(d.getHours() + 24);
                    restrictionExpiration = d.toISOString();
                } else if (strikes >= 1) {
                    newStatus = 'restricted';
                    const d = new Date();
                    d.setHours(d.getHours() + 24);
                    restrictionExpiration = d.toISOString();
                }

                const { error } = await supabase
                    .from('users')
                    .update({
                        strike_count: strikes,
                        account_status: newStatus,
                        restriction_expiration_date: restrictionExpiration,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId);

                if (error) throw error;

                // Log the manual adjustment
                await supabase.from('account_status_logs').insert({
                    user_id: userId,
                    strike_number: strikes,
                    violation_type: 'Manual Adjustment',
                    action_taken: `Strikes adjusted to ${strikes} by admin`,
                    message: `Admin manually adjusted strikes to ${strikes}`
                });

                alert('Strikes updated successfully.');
                loadModerationUsers();
                document.querySelector('.fixed.inset-0')?.remove();
            } catch (error) {
                console.error('Error adjusting strikes:', error);
                alert('Error adjusting strikes: ' + error.message);
            }
        }

        async function unbanUser(userId) {
            if (!confirm('Are you sure you want to unban this user? This will restore their account to active status and reset their strikes.')) return;

            try {
                const { error } = await supabase
                    .from('users')
                    .update({
                        account_status: 'active',
                        strike_count: 0,
                        restriction_expiration_date: null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId);

                if (error) throw error;

                // Log the unban
                await supabase.from('account_status_logs').insert({
                    user_id: userId,
                    strike_number: 0,
                    violation_type: 'Manual Unban',
                    action_taken: 'Unbanned by admin',
                    message: 'User unbanned by admin'
                });

                alert('User unbanned successfully.');
                loadModerationUsers();
                document.querySelector('.fixed.inset-0')?.remove();
            } catch (error) {
                console.error('Error unbanning user:', error);
                alert('Error unbanning user: ' + error.message);
            }
        }

        async function removeRestriction(userId) {
            if (!confirm('Are you sure you want to remove the restriction from this user?')) return;

            try {
                const { error } = await supabase
                    .from('users')
                    .update({
                        account_status: 'active',
                        restriction_expiration_date: null,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', userId);

                if (error) throw error;

                alert('Restriction removed successfully.');
                loadModerationUsers();
                document.querySelector('.fixed.inset-0')?.remove();
            } catch (error) {
                console.error('Error removing restriction:', error);
                alert('Error removing restriction: ' + error.message);
            }
        }

        async function addManualStrike(userId) {
            // Get violation reasons for selection
            const { data: reasons } = await supabase
                .from('violation_reasons')
                .select('*')
                .eq('is_active', true)
                .order('name');

            if (!reasons || reasons.length === 0) {
                alert('No violation reasons available. Please add violation reasons first.');
                return;
            }

            const reasonOptions = reasons.map(r => `${r.id}: ${r.name}`).join('\n');
            const selectedReason = prompt(`Select violation reason ID:\n${reasonOptions}\n\nOr enter custom reason:`, '1');
            if (!selectedReason) return;

            const reasonId = parseInt(selectedReason.split(':')[0]);
            const customReason = isNaN(reasonId) ? selectedReason : null;

            if (!confirm('Are you sure you want to add a manual strike to this user?')) return;

            try {
                // Use the increment_user_strike RPC with idempotency key
                const idempotencyKey = `manual_strike:${userId}:${Date.now()}`;
                const { data, error } = await supabase.rpc('increment_user_strike', {
                    p_user_id: userId,
                    p_reason_id: reasonId || 1,
                    p_idempotency_key: idempotencyKey
                });

                if (error) throw error;

                // Log manual strike
                await supabase.from('account_status_logs').insert({
                    user_id: userId,
                    strike_number: data?.[0]?.strike_count || 1,
                    violation_type: customReason || reasons.find(r => r.id === reasonId)?.name || 'Manual Strike',
                    action_taken: 'Manual Strike Added',
                    message: `Manual strike added by admin: ${customReason || reasons.find(r => r.id === reasonId)?.name || 'N/A'}`
                });

                alert('Manual strike added successfully.');
                loadModerationUsers();
                document.querySelector('.fixed.inset-0')?.remove();
            } catch (error) {
                console.error('Error adding manual strike:', error);
                alert('Error adding manual strike: ' + error.message);
            }
        }

        async function editViolationReason(reasonId) {
            try {
                const { data: reason, error } = await supabase
                    .from('violation_reasons')
                    .select('*')
                    .eq('id', reasonId)
                    .single();

                if (error) throw error;

                // Create edit modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center p-8 z-50';
                modal.innerHTML = `
                    <div class="bg-black border border-gray-800 p-8 w-full max-w-lg">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-black font-mono">EDIT VIOLATION REASON</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-white text-2xl">&times;</button>
                        </div>
                        
                        <div class="input-group mb-4">
                            <label class="input-label">Name (ID)</label>
                            <input type="text" id="edit-reason-name" class="raw-input" value="${sanitize(reason.name)}" readonly>
                        </div>
                        
                        <div class="input-group mb-4">
                            <label class="input-label">Description</label>
                            <textarea id="edit-reason-description" class="raw-input h-24 resize-none">${sanitize(reason.description || '')}</textarea>
                        </div>
                        
                        <div class="input-group mb-4">
                            <label class="input-label">Default Message</label>
                            <textarea id="edit-reason-message" class="raw-input h-24 resize-none">${sanitize(reason.default_message || '')}</textarea>
                        </div>
                        
                        <div class="input-group mb-4">
                            <label class="input-label">
                                <input type="checkbox" id="edit-reason-active" ${reason.is_active ? 'checked' : ''} class="mr-2">
                                Active
                            </label>
                        </div>
                        
                        <div class="flex gap-4">
                            <button onclick="saveViolationReason(${reasonId})" class="action-btn flex-1">
                                SAVE
                            </button>
                            <button onclick="this.closest('.fixed').remove()" class="action-btn flex-1 bg-[#111] text-white border border-gray-800">
                                CANCEL
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            } catch (error) {
                console.error('Error loading violation reason:', error);
                alert('Error loading violation reason: ' + error.message);
            }
        }

        async function saveViolationReason(reasonId) {
            try {
                const description = document.getElementById('edit-reason-description').value;
                const defaultMessage = document.getElementById('edit-reason-message').value;
                const isActive = document.getElementById('edit-reason-active').checked;

                const { error } = await supabase
                    .from('violation_reasons')
                    .update({
                        description: description,
                        default_message: defaultMessage,
                        is_active: isActive
                    })
                    .eq('id', reasonId);

                if (error) throw error;

                alert('Violation reason updated successfully.');
                loadViolationReasons();
                document.querySelector('.fixed.inset-0')?.remove();
            } catch (error) {
                console.error('Error saving violation reason:', error);
                alert('Error saving violation reason: ' + error.message);
            }
        }

        function createViolationReason() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center p-8 z-50';
            modal.innerHTML = `
                <div class="bg-black border border-gray-800 p-8 w-full max-w-lg">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-black font-mono">CREATE VIOLATION REASON</h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-white text-2xl">&times;</button>
                    </div>
                    
                    <div class="input-group mb-4">
                        <label class="input-label">Name (Unique ID)</label>
                        <input type="text" id="new-reason-name" class="raw-input" placeholder="e.g. custom_violation">
                        <p class="text-[9px] text-gray-500 mt-1">Must be unique, lowercase, underscores only</p>
                    </div>
                    
                    <div class="input-group mb-4">
                        <label class="input-label">Description</label>
                        <textarea id="new-reason-description" class="raw-input h-24 resize-none" placeholder="Describe what this violation type means"></textarea>
                    </div>
                    
                    <div class="input-group mb-4">
                        <label class="input-label">Default Message</label>
                        <textarea id="new-reason-message" class="raw-input h-24 resize-none" placeholder="Default message shown to users"></textarea>
                    </div>
                    
                    <div class="input-group mb-4">
                        <label class="input-label">
                            <input type="checkbox" id="new-reason-active" checked class="mr-2">
                            Active
                        </label>
                    </div>
                    
                    <div class="flex gap-4">
                        <button onclick="saveNewViolationReason()" class="action-btn flex-1">
                            CREATE
                        </button>
                        <button onclick="this.closest('.fixed').remove()" class="action-btn flex-1 bg-[#111] text-white border border-gray-800">
                            CANCEL
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function saveNewViolationReason() {
            try {
                const name = document.getElementById('new-reason-name').value.trim();
                const description = document.getElementById('new-reason-description').value.trim();
                const defaultMessage = document.getElementById('new-reason-message').value.trim();
                const isActive = document.getElementById('new-reason-active').checked;

                if (!name) {
                    alert('Name is required');
                    return;
                }

                // Validate name format (lowercase, underscores, no spaces)
                if (!/^[a-z0-9_]+$/.test(name)) {
                    alert('Name must be lowercase letters, numbers, and underscores only');
                    return;
                }

                const { error } = await supabase
                    .from('violation_reasons')
                    .insert({
                        name: name,
                        description: description || null,
                        default_message: defaultMessage || null,
                        is_active: isActive
                    });

                if (error) {
                    if (error.code === '23505') {
                        alert('A violation reason with this name already exists.');
                    } else {
                        throw error;
                    }
                    return;
                }

                alert('Violation reason created successfully.');
                loadViolationReasons();
                document.querySelector('.fixed.inset-0')?.remove();
            } catch (error) {
                console.error('Error creating violation reason:', error);
                alert('Error creating violation reason: ' + error.message);
            }
        }

        // ============================================
        // DATA LOADING
        // ============================================
        function loadData() {
            refreshDashboard();
            loadReleaseHistory();
            loadUsers();
            setInterval(refreshDashboard, 30000);
        }

        async function refreshDashboard() {
            try {
                // Get user count - try RPC first, fallback to count
                let userCount = 0;
                try {
                    const { data } = await supabase.rpc('get_user_count');
                    userCount = data || 0;
                } catch (e) {
                    const { count } = await supabase.from('users').select('*', { count: 'exact', head: true });
                    userCount = count || 0;
                }

                // Get network stats
                const { data: stats } = await supabase.from('network_stats').select('*').eq('id', 1).maybeSingle();
                
                // Get downloads - try RPC first, fallback to analytics_events
                let downloads = 0;
                try {
                    const { data } = await supabase.rpc('get_download_count');
                    downloads = data || 0;
                } catch (e) {
                    // Fallback: count download events from analytics
                    const { count } = await supabase
                        .from('analytics_events')
                        .select('*', { count: 'exact', head: true })
                        .eq('event_type', 'app_download');
                    downloads = count || 0;
                }

                // Get current active release
                const { data: release } = await supabase
                    .from('app_releases')
                    .select('version_name')
                    .eq('is_active', true)
                    .limit(1)
                    .maybeSingle();

                // Get flagged signals count
                let flaggedCount = 0;
                try {
                    const { count } = await supabase
                        .from('moderation_evidence')
                        .select('*', { count: 'exact', head: true });
                    flaggedCount = count || 0;
                } catch (e) {
                    flaggedCount = 0;
                }

                document.getElementById('val-nodes').textContent = userCount.toLocaleString();
                document.getElementById('val-downloads').textContent = downloads.toLocaleString();
                document.getElementById('val-version').textContent = release ? sanitize(release.version_name) : '--';
                document.getElementById('val-flagged').textContent = flaggedCount.toLocaleString();
            } catch (e) { 
                console.error('Error refreshing dashboard:', e);
            }
        }

        async function loadReleaseHistory() {
            try {
                const { data: releases, error } = await supabase
                    .from('app_releases')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(20);

                if (error) throw error;
                renderReleaseHistory(releases);
            } catch (error) { console.error(error); }
        }

        function renderReleaseHistory(releases) {
            const container = document.getElementById('release-history-list');
            if (!releases || releases.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">No releases yet</div>';
                return;
            }
            // SECURITY FIX: Sanitized outputs
            container.innerHTML = releases.map(release => `
                <div class="grid grid-cols-6 p-4 border-b border-gray-900 items-center hover:bg-[#0a0a0a] transition">
                    <div>
                        <span class="text-[9px] font-bold ${release.is_active ? 'bg-green-900/30 text-green-500 border border-green-800' : 'bg-gray-900/30 text-gray-500 border border-gray-800'} px-2 py-1">
                            ${release.is_active ? 'ACTIVE' : 'INACTIVE'}
                        </span>
                    </div>
                    <div class="text-xs font-bold text-white">${sanitize(release.version_name)}</div>
                    <div class="text-[10px] font-mono text-gray-400">${sanitize(release.build_number)}</div>
                    <div class="text-[10px] font-mono text-gray-400">${sanitize(release.android_min_version)}+</div>
                    <div class="text-[10px] font-mono text-gray-400">${release.apk_size_mb || 'N/A'}MB</div>
                    <div class="text-[10px] font-mono text-gray-500 text-right">${new Date(release.created_at).toLocaleDateString()}</div>
                </div>
            `).join('');
        }

        async function loadUsers(searchTerm = '') {
            try {
                // Use admin RPC function to bypass RLS
                const { data: users, error } = await supabase.rpc('admin_get_users', {
                    search_term: searchTerm || ''
                });

                if (error) throw error;
                renderUsers(users || []);
            } catch (error) { 
                console.error('Error loading users:', error);
                document.getElementById('users-list').innerHTML = `<div class="p-4 text-center text-red-500">Error loading users: ${error.message}</div>`;
            }
        }

        function renderUsers(users) {
            const container = document.getElementById('users-list');
            if (!users || users.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">No users found</div>';
                return;
            }
            
            // SECURITY FIX: Sanitized outputs
            container.innerHTML = users.map(user => {
                const status = user.account_status || 'active';
                const statusColor = {
                    'active': '#10b981',
                    'restricted': '#f59e0b',
                    'banned': '#ef4444'
                }[status] || '#6b7280';
                
                return `
                    <div class="grid grid-cols-5 p-4 border-b border-gray-900 items-center hover:bg-[#0a0a0a] transition">
                        <div class="col-span-2 flex items-center gap-3">
                            <div class="w-8 h-8 bg-gray-800 rounded-sm overflow-hidden">
                                <img src="${safeUrl(user.avatar_url) || 'https://via.placeholder.com/32'}" class="w-full h-full object-cover" onerror="this.src='https://via.placeholder.com/32';">
                            </div>
                            <div>
                                <div class="text-xs font-bold text-white">${sanitize(user.display_name) || 'Unknown'}</div>
                                <div class="text-[9px] font-mono text-gray-500">@${sanitize(user.handle) || 'unknown'}</div>
                                ${user.strike_count > 0 ? `<div class="text-[8px] font-mono text-red-400">Strikes: ${user.strike_count}/3</div>` : ''}
                            </div>
                        </div>
                        <div class="text-[10px] font-mono text-gray-400">${new Date(user.created_at).toLocaleDateString()}</div>
                        <div>
                            <span class="text-[9px] font-bold px-2 py-1" style="background-color: ${statusColor}20; color: ${statusColor}; border: 1px solid ${statusColor}40;">
                                ${status.toUpperCase()}
                            </span>
                        </div>
                        <div class="text-right">
                            <button onclick="viewUserDetails('${user.id}')" class="text-[9px] font-mono text-white underline hover:text-gray-400 mr-2">VIEW</button>
                            ${status === 'banned' || status === 'restricted' ? `<button onclick="manageUser('${user.id}')" class="text-[9px] font-mono text-red-400 underline hover:text-red-300">MANAGE</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function viewUserDetails(userId) {
            // Redirect to moderation user management
            switchTab('moderation', document.querySelector('[onclick*="moderation"]'));
            setTimeout(() => {
                switchModerationTab('users', document.querySelector('.mod-tab-btn'));
                manageUser(userId);
            }, 100);
        }

        function searchUsers(event) {
            const term = event.target.value.trim();
            if (term.length >= 2 || term.length === 0) loadUsers(term);
        }

        // ============================================
        // DEPLOY LOGIC
        // ============================================
        let selectedFile = null;
        const GITHUB_OWNER = 'yousseftameryty';
        const GITHUB_REPO = 'KemetCorp';

        function handleDragOver(event) { event.preventDefault(); event.currentTarget.style.borderColor = '#22c55e'; event.currentTarget.style.background = 'rgba(34, 197, 94, 0.1)'; }
        function handleDragLeave(event) { event.preventDefault(); event.currentTarget.style.borderColor = '#444'; event.currentTarget.style.background = '#050505'; }
        function handleDrop(event) {
            event.preventDefault(); event.currentTarget.style.borderColor = '#444'; event.currentTarget.style.background = '#050505';
            const files = event.dataTransfer.files;
            if (files.length > 0 && files[0].name.endsWith('.apk')) {
                const fakeEvent = { target: { files: [files[0]] } };
                handleFileSelect(fakeEvent);
            }
        }
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.name.endsWith('.apk')) {
                selectedFile = file;
                document.getElementById('deploy-size').value = `${(file.size / 1024 / 1024).toFixed(2)}MB`;
                document.getElementById('dropArea').innerHTML = `<span class="text-xs font-bold text-green-500">${sanitize(file.name)}</span>`;
            }
        }

        function generateVersionNumber() {
            const now = new Date();
            return `${now.getFullYear().toString().slice(-2)}.${String(now.getMonth() + 1).padStart(2, '0')}.${String(now.getDate()).padStart(2, '0')}`;
        }
        function generateBuildNumber() {
            const now = new Date();
            return `${now.getFullYear()}${String(now.getMonth()+1).padStart(2,'0')}${String(now.getDate()).padStart(2,'0')}${String(now.getHours()).padStart(2,'0')}${String(now.getMinutes()).padStart(2,'0')}`;
        }

        async function autoFillVersionAndBuild() {
            const verInput = document.getElementById('deploy-version');
            const buildInput = document.getElementById('deploy-build');
            if(!verInput.value) verInput.value = generateVersionNumber();
            if(!buildInput.value) buildInput.value = generateBuildNumber();
        }

        async function calculateDeploySize() {
            const url = document.getElementById('deploy-url').value;
            if(!url) return;
            try {
                const res = await fetch(url, { method: 'HEAD' });
                if(res.ok) document.getElementById('deploy-size').value = `${(parseInt(res.headers.get('content-length')) / 1048576).toFixed(2)}MB`;
            } catch(e) { console.error(e); }
        }

        async function deployBuild() {
            const btn = document.getElementById('deploy-btn');
            const version = document.getElementById('deploy-version').value;
            const build = document.getElementById('deploy-build').value;
            const apkUrl = document.getElementById('deploy-url').value || document.getElementById('post-deploy-url')?.value;
            
            if(!version || !build) return alert("Missing Version info");
            
            if(!apkUrl) {
                const releaseTag = `v${version}`;
                const ghUrl = `https://github.com/${GITHUB_OWNER}/${GITHUB_REPO}/releases/new?tag=${releaseTag}&title=KEMET%20${version}`;
                window.open(ghUrl, '_blank');
                let postDeploy = document.getElementById('post-deploy-interface');
                if (!postDeploy) {
                    postDeploy = document.createElement('div');
                    postDeploy.id = 'post-deploy-interface';
                    postDeploy.className = 'fixed inset-0 bg-black/80 flex items-center justify-center p-8';
                    postDeploy.innerHTML = `<div class="bg-black border border-gray-800 p-8 w-full max-w-lg"><input id="post-deploy-url" class="raw-input mb-4" placeholder="Paste APK URL"><button onclick="deployBuild()" class="action-btn w-full">CONFIRM</button></div>`;
                    document.body.appendChild(postDeploy);
                } else {
                    postDeploy.classList.remove('hidden');
                }
                return;
            }

            btn.innerText = "DEPLOYING...";
            
            try {
                await supabase.from('app_releases').update({ is_active: false }).eq('is_active', true);
                const { error } = await supabase.from('app_releases').insert({
                    version_name: version,
                    build_number: build,
                    android_min_version: document.getElementById('deploy-android').value,
                    apk_url: apkUrl,
                    apk_size_mb: parseFloat(document.getElementById('deploy-size').value.replace('MB','')),
                    release_notes: document.getElementById('deploy-notes').value,
                    release_type: document.getElementById('deploy-type').value,
                    is_active: true
                });

                if(error) throw error;
                btn.innerText = "SUCCESS";
                btn.style.backgroundColor = "#22c55e";
                document.getElementById('post-deploy-interface')?.classList.add('hidden');
                loadReleaseHistory();
            } catch(e) {
                console.error(e);
                alert("Deploy Failed: " + e.message);
                btn.innerText = "Push to Production";
            }
        }

        // ============================================
        // DATABASE MANAGEMENT FUNCTIONS
        // ============================================
        let currentTableName = null;

        async function loadDatabaseTables() {
            try {
                // Use admin RPC function to get table list
                const { data: tables, error } = await supabase.rpc('admin_get_tables');

                if (error) {
                    console.error('Error loading tables:', error);
                    // Fallback: use hardcoded list of known tables
                    const knownTables = [
                        'users', 'posts', 'ban_appeals', 'account_status_logs', 'violation_reasons',
                        'notifications', 'events', 'moderation_evidence', 'app_releases',
                        'post_acks', 'post_refracts', 'poll_votes', 'saved_posts',
                        'hashtags', 'hashtag_posts', 'follows', 'user_blocks', 'user_mutes'
                    ];
                    renderDatabaseTables(knownTables.map(name => ({ table_name: name, column_count: 0 })));
                    return;
                }

                renderDatabaseTables(tables || []);
            } catch (error) {
                console.error('Error loading database tables:', error);
                // Fallback to known tables
                const knownTables = [
                    'users', 'posts', 'ban_appeals', 'account_status_logs', 'violation_reasons',
                    'notifications', 'events', 'moderation_evidence', 'app_releases'
                ];
                renderDatabaseTables(knownTables.map(name => ({ table_name: name, column_count: 0 })));
            }
        }

        function renderDatabaseTables(tables) {
            const container = document.getElementById('database-tables-list');
            if (!tables || tables.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">No tables found</div>';
                return;
            }

            container.innerHTML = `
                <div class="grid grid-cols-4 p-3 bg-[#0a0a0a] border-b border-gray-800 text-[9px] font-mono text-gray-500 uppercase">
                    <span>Table Name</span>
                    <span>Columns</span>
                    <span>Actions</span>
                    <span class="text-right">Quick Actions</span>
                </div>
                ${tables.map(table => `
                    <div class="grid grid-cols-4 p-4 border-b border-gray-900 items-center hover:bg-[#0a0a0a] transition">
                        <div class="text-xs font-bold text-white font-mono">${sanitize(table.table_name)}</div>
                        <div class="text-[10px] font-mono text-gray-400">${table.column_count || 'N/A'} cols</div>
                        <div>
                            <button onclick="viewTable('${sanitize(table.table_name)}')" class="text-[9px] font-mono text-white underline hover:text-gray-400">VIEW</button>
                        </div>
                        <div class="text-right">
                            <button onclick="queryTable('${sanitize(table.table_name)}')" class="text-[9px] font-mono text-blue-400 underline hover:text-blue-300 mr-2">QUERY</button>
                            <button onclick="exportTable('${sanitize(table.table_name)}')" class="text-[9px] font-mono text-green-400 underline hover:text-green-300">EXPORT</button>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        async function viewTable(tableName) {
            currentTableName = tableName;
            document.getElementById('table-viewer').classList.remove('hidden');
            document.getElementById('table-viewer-name').textContent = `TABLE: ${tableName}`;
            
            try {
                // Use admin RPC function to bypass RLS
                const { data: result, error } = await supabase.rpc('admin_view_table', {
                    p_table_name: tableName,
                    p_limit: 100
                });

                if (error) throw error;
                
                // Parse JSONB result
                const tableData = Array.isArray(result) ? result : (result ? JSON.parse(JSON.stringify(result)) : []);
                renderTableData(tableName, tableData);
            } catch (error) {
                console.error('Error loading table data:', error);
                document.getElementById('table-viewer-content').innerHTML = 
                    `<div class="p-4 text-center text-red-500">Error loading table: ${error.message}</div>`;
            }
        }

        function renderTableData(tableName, data) {
            const container = document.getElementById('table-viewer-content');
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="p-4 text-center text-gray-500">No data found</div>';
                return;
            }

            // Get column names from first row
            const columns = Object.keys(data[0]);
            
            container.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-[10px] font-mono">
                        <thead class="bg-[#0a0a0a] border-b border-gray-800">
                            <tr>
                                ${columns.map(col => `<th class="p-2 text-left text-gray-400 uppercase">${sanitize(col)}</th>`).join('')}
                                <th class="p-2 text-right text-gray-400">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map((row, idx) => `
                                <tr class="border-b border-gray-900 hover:bg-[#0a0a0a]">
                                    ${columns.map(col => {
                                        const value = row[col];
                                        let displayValue = value;
                                        if (value === null || value === undefined) displayValue = '<span class="text-gray-600">NULL</span>';
                                        else if (typeof value === 'object') displayValue = JSON.stringify(value).substring(0, 50) + '...';
                                        else if (String(value).length > 50) displayValue = String(value).substring(0, 50) + '...';
                                        else displayValue = sanitize(String(value));
                                        return `<td class="p-2 text-gray-300">${displayValue}</td>`;
                                    }).join('')}
                                    <td class="p-2 text-right">
                                        <button onclick="editTableRow('${tableName}', ${idx})" class="text-blue-400 underline hover:text-blue-300 mr-2">EDIT</button>
                                        <button onclick="deleteTableRow('${tableName}', '${row.id || idx}')" class="text-red-400 underline hover:text-red-300">DELETE</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    <div class="p-4 text-center text-gray-500 text-[9px]">
                        Showing ${data.length} rows (limited to 100)
                    </div>
                </div>
            `;
        }

        function refreshTableViewer() {
            if (currentTableName) {
                viewTable(currentTableName);
            }
        }

        function closeTableViewer() {
            document.getElementById('table-viewer').classList.add('hidden');
            currentTableName = null;
        }

        function showSQLQuery() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black/80 flex items-center justify-center p-8 z-50';
            modal.innerHTML = `
                <div class="bg-black border border-gray-800 p-8 w-full max-w-4xl max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-black font-mono">SQL QUERY EXECUTOR</h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-white text-2xl">&times;</button>
                    </div>
                    <div class="mb-4">
                        <label class="input-label">SQL Query (SELECT only for safety)</label>
                        <textarea id="sql-query-input" class="raw-input h-32 resize-none font-mono" placeholder="SELECT * FROM users LIMIT 10;"></textarea>
                    </div>
                    <div class="flex gap-4 mb-4">
                        <button onclick="executeSQLQuery()" class="action-btn flex-1">EXECUTE</button>
                        <button onclick="this.closest('.fixed').remove()" class="action-btn flex-1 bg-[#111] text-white border border-gray-800">CANCEL</button>
                    </div>
                    <div id="sql-query-results" class="border border-gray-800 p-4 min-h-[200px] max-h-[400px] overflow-y-auto">
                        <div class="text-gray-500 text-center">Query results will appear here...</div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        async function executeSQLQuery() {
            const query = document.getElementById('sql-query-input').value.trim();
            const resultsDiv = document.getElementById('sql-query-results');
            
            if (!query) {
                resultsDiv.innerHTML = '<div class="text-red-500">Please enter a query</div>';
                return;
            }

            // Safety check - only allow SELECT queries
            if (!query.toUpperCase().trim().startsWith('SELECT')) {
                resultsDiv.innerHTML = '<div class="text-red-500">Only SELECT queries are allowed for safety</div>';
                return;
            }

            try {
                resultsDiv.innerHTML = '<div class="text-gray-500">Executing query...</div>';
                
                // Parse simple SELECT queries and use admin RPC
                const tableMatch = query.match(/FROM\s+(\w+)/i);
                if (tableMatch) {
                    const tableName = tableMatch[1];
                    const { data: result, error } = await supabase.rpc('admin_view_table', {
                        p_table_name: tableName,
                        p_limit: 100
                    });
                    
                    if (error) throw error;
                    
                    const data = Array.isArray(result) ? result : (result ? JSON.parse(JSON.stringify(result)) : []);
                    
                    if (!data || data.length === 0) {
                        resultsDiv.innerHTML = '<div class="text-gray-500">No results found</div>';
                        return;
                    }

                    const columns = Object.keys(data[0]);
                    resultsDiv.innerHTML = `
                        <div class="overflow-x-auto">
                            <table class="w-full text-[10px] font-mono">
                                <thead class="bg-[#0a0a0a] border-b border-gray-800">
                                    <tr>
                                        ${columns.map(col => `<th class="p-2 text-left text-gray-400">${sanitize(col)}</th>`).join('')}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${data.map(row => `
                                        <tr class="border-b border-gray-900">
                                            ${columns.map(col => {
                                                const value = row[col];
                                                let displayValue = value === null ? '<span class="text-gray-600">NULL</span>' : sanitize(String(value));
                                                if (String(value).length > 100) displayValue = String(value).substring(0, 100) + '...';
                                                return `<td class="p-2 text-gray-300">${displayValue}</td>`;
                                            }).join('')}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            <div class="mt-4 text-gray-500 text-[9px]">Showing ${data.length} rows</div>
                        </div>
                    `;
                } else {
                    resultsDiv.innerHTML = '<div class="text-red-500">Could not parse table name from query</div>';
                }
            } catch (error) {
                console.error('SQL query error:', error);
                resultsDiv.innerHTML = `<div class="text-red-500">Error: ${sanitize(error.message)}</div>`;
            }
        }

        function queryTable(tableName) {
            showSQLQuery();
            setTimeout(() => {
                document.getElementById('sql-query-input').value = `SELECT * FROM ${tableName} LIMIT 100;`;
            }, 100);
        }

        async function exportTable(tableName) {
            try {
                // Use admin RPC function to bypass RLS
                const { data: result, error } = await supabase.rpc('admin_view_table', {
                    p_table_name: tableName,
                    p_limit: 1000
                });

                if (error) throw error;
                
                // Parse JSONB result
                const data = Array.isArray(result) ? result : (result ? JSON.parse(JSON.stringify(result)) : []);
                const csv = convertToCSV(data);
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${tableName}_export_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error exporting table: ' + error.message);
            }
        }

        function convertToCSV(data) {
            if (!data || data.length === 0) return '';
            const headers = Object.keys(data[0]);
            const rows = data.map(row => 
                headers.map(header => {
                    const value = row[header];
                    if (value === null || value === undefined) return '';
                    if (typeof value === 'object') return JSON.stringify(value);
                    return String(value).replace(/"/g, '""');
                }).map(v => `"${v}"`).join(',')
            );
            return [headers.join(','), ...rows].join('\n');
        }

        function editTableRow(tableName, rowIndex) {
            alert('Row editor coming soon. For now, use SQL query or database tools.');
        }

        async function deleteTableRow(tableName, rowId) {
            if (!confirm(`Are you sure you want to delete this row from ${tableName}?`)) return;
            
            try {
                const { error } = await supabase.from(tableName).delete().eq('id', rowId);
                if (error) throw error;
                alert('Row deleted successfully.');
                refreshTableViewer();
            } catch (error) {
                alert('Error deleting row: ' + error.message);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('password-input')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') signIn();
            });
            initApp();
        });
    </script>
</body>
</html>