<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
5→    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
6→    <title>KEMET // RESET CREDENTIALS</title>
7→    <link rel="icon" href="/Kemet.png" type="image/png">
8→    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=JetBrains+Mono:wght@400;800&display=swap" rel="stylesheet">
    <style>
        :root { --kemet-green: #22c55e; }
        body { background-color: #000; color: white; font-family: 'Inter', sans-serif; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .noise {
            position: fixed; inset: 0; pointer-events: none; z-index: 10; opacity: 0.04;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
        }
        .scanlines {
            position: fixed; inset: 0; pointer-events: none; z-index: 5;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.15) 50%, rgba(0,0,0,0.15));
            background-size: 100% 4px;
        }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; }
        ::-webkit-scrollbar-thumb:hover { background: #fff; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="min-h-screen flex items-center justify-center px-4 selection:bg-green-500 selection:text-black">
    <div class="noise"></div>
    <div class="scanlines"></div>

    <div class="w-full max-w-md relative z-20">
        <div class="mb-8 flex items-center justify-between">
            <div>
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-emerald-400 shadow-[0_0_12px_#22c55e]"></div>
                    <span class="text-sm font-black tracking-tight">KEMET.</span>
                </div>
                <p class="mt-1 text-[10px] font-mono text-gray-500 uppercase tracking-[0.25em]">Credential_Recovery</p>
            </div>
            <div class="text-right">
                <p class="text-[9px] font-mono text-gray-500 uppercase tracking-[0.2em]">FILE: RESET_01</p>
                <p class="text-[9px] font-mono text-gray-600">Access requires a valid recovery link.</p>
            </div>
        </div>

        <div class="bg-black border border-gray-800 px-6 py-6 md:px-8 md:py-8 shadow-[0_0_40px_rgba(0,0,0,0.8)]">
            <h1 class="text-2xl md:text-3xl font-black tracking-tight mb-2">Reset Passkey.</h1>
            <p class="text-sm text-gray-400 mb-6 max-w-xs">
                Set a new private passkey for your node. This link is single-use and time-limited.
            </p>

            <div id="link-state" class="mb-4 hidden">
                <div class="text-[10px] font-mono text-red-400 bg-red-950/40 border border-red-900 px-3 py-2">
                    <span id="link-state-text"></span>
                </div>
            </div>

            <form id="reset-form" class="space-y-5">
                <div>
                    <label class="block font-mono text-[10px] uppercase tracking-[0.25em] text-gray-500 mb-2">
                        New Passkey
                    </label>
                    <input
                        id="password"
                        type="password"
                        minlength="6"
                        autocomplete="new-password"
                        class="w-full bg-black text-white text-sm border border-gray-700 px-3 py-2 focus:border-white outline-none"
                        placeholder="••••••••"
                        required
                    />
                </div>

                <div>
                    <label class="block font-mono text-[10px] uppercase tracking-[0.25em] text-gray-500 mb-2">
                        Confirm Passkey
                    </label>
                    <input
                        id="confirm-password"
                        type="password"
                        minlength="6"
                        autocomplete="new-password"
                        class="w-full bg-black text-white text-sm border border-gray-700 px-3 py-2 focus:border-white outline-none"
                        placeholder="••••••••"
                        required
                    />
                </div>

                <div id="error" class="text-[11px] font-mono text-red-400 min-h-[1.5rem]"></div>
                <div id="success" class="text-[11px] font-mono text-emerald-400 min-h-[1.5rem]"></div>

                <button
                    id="submit-btn"
                    type="submit"
                    class="w-full h-11 bg-white text-black text-[11px] font-black tracking-[0.25em] uppercase flex items-center justify-center disabled:bg-gray-300 disabled:text-gray-700"
                >
                    Commit New Passkey
                </button>
            </form>

            <p class="mt-4 text-[10px] font-mono text-gray-500 leading-relaxed">
                If this link has expired, return to the Kemet app and request a new recovery transmission from the login screen.
            </p>
        </div>
    </div>

    <script>
        const supabaseUrl = 'https://YOUR-PROJECT.supabase.co';
        const supabaseAnonKey = 'YOUR_PUBLIC_ANON_KEY';
        const client = window.supabase.createClient(supabaseUrl, supabaseAnonKey);

        const form = document.getElementById('reset-form');
        const passwordInput = document.getElementById('password');
        const confirmPasswordInput = document.getElementById('confirm-password');
        const errorEl = document.getElementById('error');
        const successEl = document.getElementById('success');
        const submitBtn = document.getElementById('submit-btn');
        const linkState = document.getElementById('link-state');
        const linkStateText = document.getElementById('link-state-text');

        function setError(message) {
            errorEl.textContent = message || '';
            successEl.textContent = '';
        }

        function setSuccess(message) {
            successEl.textContent = message || '';
            errorEl.textContent = '';
        }

        function setSubmitting(isSubmitting) {
            submitBtn.disabled = isSubmitting;
            submitBtn.textContent = isSubmitting ? 'Committing…' : 'Commit New Passkey';
        }

        function hasRecoveryParams() {
            const hash = window.location.hash || '';
            const search = window.location.search || '';
            return hash.includes('type=recovery') || search.includes('type=recovery');
        }

        window.addEventListener('load', () => {
            if (!hasRecoveryParams()) {
                linkState.classList.remove('hidden');
                linkStateText.textContent = 'No active recovery token detected. Use the link from your email.';
            }
        });

        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            const password = passwordInput.value || '';
            const confirmPassword = confirmPasswordInput.value || '';

            if (password.length < 6) {
                setError('Passkey must be at least 6 characters.');
                return;
            }

            if (password !== confirmPassword) {
                setError('Passkeys do not match.');
                return;
            }

            setSubmitting(true);
            setError('');
            setSuccess('');

            try {
                const { data: userData, error: userError } = await client.auth.getUser();
                if (userError || !userData || !userData.user) {
                    setError('This recovery link is invalid or has expired. Request a new link from the app.');
                    setSubmitting(false);
                    return;
                }

                const { error } = await client.auth.updateUser({ password });
                if (error) {
                    setError('Unable to update passkey. Try again or request a new link.');
                    setSubmitting(false);
                    return;
                }

                setSuccess('Passkey updated. You can now return to Kemet and sign in with your new credentials.');
                setSubmitting(false);
            } catch (e) {
                setError('Unexpected error while updating passkey. Try again.');
                setSubmitting(false);
            }
        });
    </script>
</body>
</html>
